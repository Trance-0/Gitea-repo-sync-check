name: Sync from Gitea

on:
  schedule:
    # 3 times per day (UTC) â€“ adjust if you want different times
    - cron: '0 0,8,16 * * *'
  workflow_dispatch: {}  # allow manual runs

permissions:
  contents: write  # allow GITHUB_TOKEN to push to this repo

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Check out GitHub repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # full history

      - name: Fetch from Gitea
        env:
          GITEA_URL: ${{ secrets.GITEA_URL }}
          GITEA_USER: ${{ secrets.GITEA_USERNAME }}
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
        run: |
          # Build authenticated Gitea URL: https://USER:TOKEN@...
          AUTH_URL="${GITEA_URL/https:\/\//https:\/\/$GITEA_USER:$GITEA_TOKEN@}"

          git remote add gitea "$AUTH_URL"
          git fetch gitea --prune

      - name: Mirror to GitHub
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}  # owner/repo
        run: |
          # Re-point origin to an authenticated HTTPS URL using GITHUB_TOKEN
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GH_REPO}.git"

          # Force GitHub to match whatever we fetched from Gitea
          git push origin --mirror
